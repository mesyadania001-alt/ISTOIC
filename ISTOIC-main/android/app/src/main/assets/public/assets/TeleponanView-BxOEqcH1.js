import{j as e,bv as M,a3 as L,f as U,h as V,R as $,$ as A,bm as F,ah as q,ai as H}from"./vendor-ui-BZMtAjw3.js";import{r as a}from"./vendor-react-BVD7n4_Z.js";import{r as W,d as B}from"./index-BuNBQ-bW.js";import"./vendor-ai-CXmbpsrq.js";import"./vendor-firebase-Zql6DR9P.js";class K{constructor(){this.micSource=null;const n=window.AudioContext||window.webkitAudioContext;this.ctx=new n,this.destination=this.ctx.createMediaStreamDestination(),this.outputGain=this.ctx.createGain(),this.analyser=this.ctx.createAnalyser(),this.analyser.fftSize=256,this.filter=this.ctx.createBiquadFilter(),this.outputGain.connect(this.destination),this.outputGain.connect(this.analyser)}async resume(){this.ctx.state==="suspended"&&await this.ctx.resume()}setupNodes(n){this.micSource&&this.micSource.disconnect(),this.micSource=this.ctx.createMediaStreamSource(n),this.filter.type="lowpass",this.filter.frequency.value=8e3,this.micSource.connect(this.filter),this.filter.connect(this.outputGain)}setMute(n){this.outputGain.gain.setTargetAtTime(n?0:1,this.ctx.currentTime,.05)}cleanup(){this.ctx.state!=="closed"&&this.ctx.close()}}const Y=({analyser:d,isMuted:n})=>{const i=a.useRef(null);return a.useEffect(()=>{if(!d||!i.current||n)return;const s=i.current,o=s.getContext("2d");if(!o)return;let r;const u=d.frequencyBinCount,b=new Uint8Array(u),N=()=>{r=requestAnimationFrame(N),d.getByteFrequencyData(b),o.clearRect(0,0,s.width,s.height);const x=s.width/u*2.5;let E=0;for(let f=0;f<u;f++){const w=b[f]/255*s.height;o.fillStyle="rgba(16, 185, 129, 0.8)",o.fillRect(E,s.height-w,x,w),E+=x+1}};return N(),()=>cancelAnimationFrame(r)},[d,n]),e.jsx("canvas",{ref:i,width:300,height:80,className:"w-full h-full opacity-60"})},ee=({onClose:d,existingPeer:n,initialTargetId:i,incomingCall:s,secretPin:o})=>{var I;const[r,u]=a.useState(s?"RINGING":"IDLE"),[b,N]=a.useState(0),[x,E]=a.useState(!1),[f,w]=a.useState(null),[T,C]=a.useState(0),v=a.useRef(null),j=a.useRef(null),l=a.useRef(null),m=a.useRef(null),g=a.useRef(null),k=a.useRef(null);a.useEffect(()=>{if(o&&(n!=null&&n.id)&&(i||s!=null&&s.peer)){const t=i||(s==null?void 0:s.peer);W(n.id,t,o).then(w)}},[o,n,i,s]),a.useEffect(()=>(r==="CONNECTED"?g.current=setInterval(()=>N(t=>t+1),1e3):clearInterval(g.current),()=>clearInterval(g.current)),[r]);const p=t=>{if(navigator.vibrate){const c={light:[10],medium:[30],heavy:[60]};navigator.vibrate(c[t])}},h=a.useCallback(()=>{p("heavy"),u("TERMINATED"),v.current&&v.current.close(),m.current&&m.current.getTracks().forEach(t=>t.stop()),l.current&&l.current.cleanup(),clearInterval(k.current),B.log("INFO","VOICE","TERMINATE","Call ended by user or system."),setTimeout(d,800)},[d]),R=async()=>{try{const t=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:48e3}});return m.current=t,l.current||(l.current=new K),await l.current.resume(),l.current.setupNodes(t),l.current.destination.stream}catch(t){return console.error("Mic Access Denied",t),alert("Izin mikrofon diperlukan untuk melakukan panggilan."),h(),null}},_=()=>{r!=="TERMINATED"&&(T<5?(console.warn("ICE Disconnected. Attempting Reconnect..."),u("RECONNECTING"),C(t=>t+1)):h())},S=t=>{t.on("stream",c=>{j.current&&(j.current.srcObject=c,j.current.play().catch(y=>console.warn("Autoplay blocked:",y)),u("CONNECTED"),C(0),p("medium"),k.current=setInterval(()=>{(!c.active||c.getAudioTracks()[0].readyState==="ended")&&_()},2e3))}),t.on("close",h),t.on("error",c=>{console.error("PeerJS Call Error:",c),_()})},D=async()=>{if(!i||!n)return;p("light"),u("SIGNALING");const t=await R();if(t){const c=n.call(i,t,{metadata:{type:"SECURE_VOICE_v2",pin_hash:o}});v.current=c,S(c)}},O=async()=>{if(!s)return;p("medium"),u("SECURE_HANDSHAKE");const t=await R();t&&(s.answer(t),v.current=s,S(s))},G=()=>{var c;const t=!x;E(t),(c=l.current)==null||c.setMute(t),p("light")};a.useEffect(()=>(r==="IDLE"&&i&&D(),()=>{m.current&&m.current.getTracks().forEach(t=>t.stop()),l.current&&l.current.cleanup()}),[]);const z=t=>{const c=Math.floor(t/60),y=t%60;return`${c}:${y.toString().padStart(2,"0")}`};return e.jsxs("div",{className:"fixed inset-0 z-[10000] bg-[#050505] flex flex-col font-sans text-emerald-500 animate-fade-in overflow-hidden select-none sheen",children:[e.jsx("audio",{ref:j,playsInline:!0,autoPlay:!0,className:"hidden"}),e.jsxs("div",{className:"absolute inset-0 z-0",children:[e.jsx("div",{className:"absolute inset-0 bg-[radial-gradient(circle_at_center,_transparent_0%,_#000_100%)]"}),e.jsx("div",{className:"absolute inset-0 bg-[linear-gradient(rgba(16,185,129,0.03)_1px,transparent_1px),linear-gradient(90deg,rgba(16,185,129,0.03)_1px,transparent_1px)] bg-[size:30px_30px] opacity-40"}),r==="CONNECTED"&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center opacity-10",children:e.jsx(M,{size:600,className:"text-emerald-500 animate-[pulse_4s_ease-in-out_infinite]",strokeWidth:.5})})]}),e.jsxs("header",{className:"relative z-10 p-6 pt-[calc(env(safe-area-inset-top)+1rem)] flex justify-between items-center bg-black/40 backdrop-blur-md border-b border-emerald-950/30",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`w-2.5 h-2.5 rounded-full shadow-[0_0_10px_#10b981] ${r==="CONNECTED"?"bg-emerald-500 animate-pulse":"bg-neutral-600"}`}),e.jsx("span",{className:"text-[10px] font-black uppercase tracking-[0.3em] text-white",children:"SECURE_VOICE_TUNNEL"})]}),r==="CONNECTED"&&e.jsx("div",{className:"px-3 py-1 rounded-lg bg-emerald-500/10 border border-emerald-500/20 text-emerald-400 font-mono text-xs font-black tracking-widest",children:z(b)})]}),e.jsxs("main",{className:"flex-1 flex flex-col items-center justify-center p-6 relative z-10",children:[e.jsxs("div",{className:"relative mb-10 group",children:[e.jsxs("div",{className:`w-44 h-44 rounded-full border-2 transition-all duration-700 flex items-center justify-center relative overflow-hidden
                        ${r==="CONNECTED"?"border-emerald-500/50 shadow-[0_0_50px_rgba(16,185,129,0.2)]":"border-white/10 animate-pulse"}
                        ${r==="RECONNECTING"?"border-amber-500 animate-bounce":""}
                    `,children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-emerald-500/10 to-transparent animate-scan-up"}),r==="CONNECTED"?e.jsx(L,{size:64,className:"text-emerald-400"}):e.jsx(U,{size:64,className:"text-neutral-700"})]}),r==="CONNECTED"&&f&&e.jsxs("div",{className:"absolute -bottom-4 left-1/2 -translate-x-1/2 bg-black border border-emerald-500/30 px-4 py-1.5 rounded-full shadow-2xl backdrop-blur-xl animate-fade-in",children:[e.jsx("span",{className:"text-[9px] font-black text-emerald-500 uppercase tracking-widest block text-center mb-0.5 opacity-50",children:"SAS_VERIFY"}),e.jsx("span",{className:"text-sm font-mono font-black text-white tracking-widest whitespace-nowrap",children:f})]})]}),e.jsxs("div",{className:"text-center space-y-2 mb-12",children:[e.jsx("h2",{className:"text-2xl font-black text-white tracking-tight uppercase break-all px-6",children:i||(s==null?void 0:s.peer)||"SIGNALING..."}),e.jsx("div",{className:"flex items-center justify-center gap-2 text-[10px] font-black uppercase tracking-widest text-neutral-500",children:r==="CONNECTED"?e.jsxs("span",{className:"flex items-center gap-1.5 text-emerald-500",children:[e.jsx(V,{size:10})," END_TO_END_ENCRYPTED"]}):r==="RECONNECTING"?e.jsxs("span",{className:"text-amber-500 flex items-center gap-2",children:[e.jsx($,{size:10,className:"animate-spin"})," RESTORING UPLINK..."]}):e.jsx("span",{className:"animate-pulse",children:r.replace("_"," ")})})]}),e.jsxs("div",{className:"w-full max-w-sm space-y-8 animate-slide-up pb-[calc(env(safe-area-inset-bottom)+2rem)]",children:[e.jsx("div",{className:"h-20 w-full",children:e.jsx(Y,{analyser:((I=l.current)==null?void 0:I.analyser)||null,isMuted:x})}),e.jsx("div",{className:"flex flex-col items-center gap-8",children:r==="RINGING"?e.jsxs("div",{className:"flex gap-10",children:[e.jsx("button",{onClick:h,className:"w-20 h-20 rounded-full bg-red-500/20 border border-red-500/50 text-red-500 flex items-center justify-center hover:bg-red-500 hover:text-white transition-all active:scale-90",children:e.jsx(A,{size:32})}),e.jsx("button",{onClick:O,className:"w-20 h-20 rounded-full bg-emerald-500 text-black flex items-center justify-center shadow-[0_0_30px_rgba(16,185,129,0.4)] animate-bounce active:scale-90",children:e.jsx(F,{size:32,fill:"currentColor"})})]}):r==="CONNECTED"||r==="RECONNECTING"?e.jsxs("div",{className:"grid grid-cols-2 gap-6 items-center w-full",children:[e.jsxs("button",{onClick:G,className:`w-16 h-16 rounded-2xl border transition-all flex flex-col items-center justify-center gap-1 mx-auto
                                    ${x?"bg-red-500 border-red-500 text-white animate-pulse":"bg-white/5 border-white/10 text-neutral-400 hover:text-white"}
                                `,children:[x?e.jsx(q,{size:24}):e.jsx(H,{size:24}),e.jsx("span",{className:"text-[7px] font-black uppercase",children:"MUTE"})]}),e.jsx("button",{onClick:h,className:"w-16 h-16 rounded-2xl bg-red-600 text-white flex items-center justify-center shadow-[0_0_40px_rgba(220,38,38,0.4)] hover:bg-red-500 active:scale-95 transition-all border-4 border-black mx-auto",children:e.jsx(A,{size:32,fill:"currentColor"})})]}):e.jsx("button",{onClick:h,className:"px-10 py-3 rounded-xl bg-white/5 border border-white/10 text-neutral-400 hover:text-red-500 hover:border-red-500/50 transition-all font-black text-xs tracking-widest",children:"CANCEL_UPLINK"})})]})]})]})};export{ee as TeleponanView};
